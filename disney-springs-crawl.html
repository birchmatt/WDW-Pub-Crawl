<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disney Springs Pub Crawl</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
            overflow: hidden; 
        }
        .header { 
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%); 
            color: white; 
            padding: 30px; 
        }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .header p { opacity: 0.9; }
        .content { padding: 30px; position: relative; z-index: 1; }
        .location-item { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            border-left: 5px solid #e9ecef; 
            margin-bottom: 15px; 
        }
        .location-item.visited { 
            border-left-color: #10b981; 
            background: #f0fdf4; 
        }
        .location-name { 
            font-weight: 600; 
            color: #333; 
            font-size: 1.1em; 
            margin-bottom: 10px; 
        }
        .btn { 
            padding: 12px 30px; 
            border: none; 
            border-radius: 8px; 
            font-size: 1em; 
            font-weight: 600; 
            cursor: pointer; 
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%); 
            color: white; 
            margin-top: 10px;
            width: 100%;
        }
        .btn:active {
            transform: scale(0.98);
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            color: #555; 
            font-weight: 600; 
        }
        .form-group select, .form-group input, .form-group textarea { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 1em; 
        }
        .drink-item { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .drink-photo {
            max-width: 100%;
            border-radius: 8px;
            margin: 10px 0;
            cursor: pointer;
        }
        .progress-bar { 
            background: #e9ecef; 
            height: 30px; 
            border-radius: 15px; 
            overflow: hidden; 
            margin: 15px 0; 
        }
        .progress-fill { 
            background: linear-gradient(90deg, #7c3aed 0%, #1e3a8a 100%); 
            height: 100%; 
            color: white; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: width 0.3s;
        }
        .photo-preview {
            margin-top: 10px;
        }
        .photo-preview img {
            max-width: 200px;
            border-radius: 8px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Disney Springs Pub Crawl</h1>
            <p>Track your journey through Disney Springs!</p>
        </div>
        
        <div class="content">
            <div id="loadingMessage" class="loading">Loading...</div>
            
            <div id="mainContent" style="display: none;">
                <h2>Your Progress</h2>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%">0/6 locations</div>
                </div>
                
                <div id="locationList"></div>
                
                <h2 style="margin-top: 30px;">Add Drink</h2>
                <form id="drinkForm">
                    <div class="form-group">
                        <label>Location</label>
                        <select id="location" required>
                            <option value="">Choose location...</option>
                            <option value="0">Jaleo by Jose Andres</option>
                            <option value="1">Jock Lindseys Hangar Bar</option>
                            <option value="2">The Boathouse</option>
                            <option value="3">Raglan Road</option>
                            <option value="4">Morimoto Asia</option>
                            <option value="5">Dockside Margaritas</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Drink (or enter custom below)</label>
                        <select id="drinkSelect">
                            <option value="">Select location first...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Custom Drink Name (optional)</label>
                        <input type="text" id="drinkName" placeholder="Or enter custom drink name">
                    </div>
                    
                    <div class="form-group">
                        <label>Rating (1-10)</label>
                        <input type="number" id="rating" min="1" max="10" required value="5">
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="notes" placeholder="How was it?"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Photo (optional)</label>
                        <input type="file" id="photo" accept="image/*" style="width: 100%;">
                        <div id="photoPreview" class="photo-preview" style="display: none; margin-top: 10px;">
                            <img id="previewImg" style="max-width: 200px; border-radius: 8px;">
                            <br>
                            <button type="button" id="removePhotoBtn" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 8px; margin-top: 8px; cursor: pointer;">Remove Photo</button>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn" id="submitBtn">Add Drink</button>
                </form>
                
                <h2 style="margin-top: 30px;">Your Drinks</h2>
                <div id="drinksList"></div>
            </div>
        </div>
    </div>

    <script>
        const LOCATIONS = [
            'Jaleo by Jose Andres',
            'Jock Lindseys Hangar Bar',
            'The Boathouse',
            'Raglan Road',
            'Morimoto Asia',
            'Dockside Margaritas'
        ];

        const DRINKS_BY_LOCATION = [
            ["Ultimate Gin & Tonic ($18-20)", "Sangria - Glass ($18)", "Sangria - Carafe ($48)", "Sake Sangria ($18)", "Spanish Wines", "Spanish Beers", "Craft Cocktails"],
            ["Reggie's Revenge ($15.50)", "The Mayor's Reserve ($17.50)", "Wrong Island ($14.50)", "Hovito Mojito ($15.50)", "Air Pirate's Mule ($16.50)", "The Scottish Professor ($15.50)", "Aviator's Flight - Scotch Tasting ($18)", "Jock's Old Fashioned ($18)"],
            ["Boathouse Bloody Mary ($17)", "Duck Duck Razz ($16)", "Coconut Mojito ($16)", "Blueberry Lemonade ($16)", "Shipwreck ($16)", "American Mule ($15)", "Espresso Martini ($15)", "Orange Crush ($8)"],
            ["Pint of Guinness", "Irish Craft Beer", "Iced Irish ($16-18)", "Irish Espresso Martini", "The Florida Split (Vodka, Mango, Ice Cream)", "Irish Whiskeys", "Cocktails"],
            ["Smoked Old Fashioned ($34)", "Mars Shinshu Japanese Whiskey ($20)", "Matcha Lavender Cocktail ($19)", "Mezcal Cocktails ($19)", "Japanese Whisky ($16-170)", "Sake Sangria ($18/$48)", "Coffee Cocktails ($19)"],
            ["Habanero Lime Margarita ($18)", "Frozen Strawberry Margarita ($17)", "Sunset Margarita ($18)", "Watermelon Margarita ($17.50)", "Orange Grove Rum Runner ($16)", "Dockside Iced Tea ($16.50)", "Key Lime Freeze ($17)"]
        ];

        let db;
        let drinks = [];
        let currentPhotoData = null;

        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('SpringsCrawlDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('drinks')) {
                        db.createObjectStore('drinks', { keyPath: 'id' });
                    }
                };
            });
        }

        // Load all drinks from IndexedDB
        function loadData() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['drinks'], 'readonly');
                const store = transaction.objectStore('drinks');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    drinks = request.result || [];
                    resolve(drinks);
                };
                request.onerror = () => reject(request.error);
            });
        }

        // Save a drink to IndexedDB
        function saveDrink(drink) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['drinks'], 'readwrite');
                const store = transaction.objectStore('drinks');
                const request = store.put(drink);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // Delete a drink from IndexedDB
        function deleteDrinkFromDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['drinks'], 'readwrite');
                const store = transaction.objectStore('drinks');
                const request = store.delete(id);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function updateDisplay() {
            const visited = new Set(drinks.map(d => d.locationIndex));
            const progress = Math.round((visited.size / 6) * 100);
            
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressFill').textContent = visited.size + '/6 locations';
            
            let locationHTML = '';
            for (let i = 0; i < LOCATIONS.length; i++) {
                const isVisited = visited.has(i);
                locationHTML += '<div class="location-item' + (isVisited ? ' visited' : '') + '">';
                locationHTML += '<div class="location-name">' + (i + 1) + '. ' + LOCATIONS[i] + '</div>';
                if (isVisited) {
                    locationHTML += '<div style="color: #10b981; font-weight: 600;">✓ Visited</div>';
                }
                locationHTML += '</div>';
            }
            document.getElementById('locationList').innerHTML = locationHTML;
            
            if (drinks.length === 0) {
                document.getElementById('drinksList').innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">No drinks yet!</p>';
            } else {
                let drinksHTML = '';
                const sortedDrinks = drinks.slice().reverse();
                for (let i = 0; i < sortedDrinks.length; i++) {
                    const d = sortedDrinks[i];
                    drinksHTML += '<div class="drink-item">';
                    drinksHTML += '<strong>' + d.drinkName + '</strong><br>';
                    drinksHTML += '<span style="color: #666;">' + LOCATIONS[d.locationIndex] + '</span><br>';
                    drinksHTML += '<span style="color: #fbbf24;">' + '★'.repeat(d.rating) + '</span><br>';
                    if (d.photo) {
                        drinksHTML += '<img src="' + d.photo + '" class="drink-photo" onclick="openPhotoModal(' + d.id + ')">';
                    }
                    if (d.notes) {
                        drinksHTML += '<em>' + d.notes + '</em><br>';
                    }
                    drinksHTML += '<button onclick="deleteDrink(' + d.id + ')" style="background: #dc3545; padding: 8px 16px; font-size: 0.9em; border: none; color: white; border-radius: 8px; margin-top: 10px; cursor: pointer;">Delete</button>';
                    drinksHTML += '</div>';
                }
                document.getElementById('drinksList').innerHTML = drinksHTML;
            }
        }

        function updateDrinkOptions() {
            const locationIndex = document.getElementById('location').value;
            const drinkSelect = document.getElementById('drinkSelect');
            
            if (locationIndex === '') {
                drinkSelect.innerHTML = '<option value="">Select location first...</option>';
                return;
            }
            
            const drinks = DRINKS_BY_LOCATION[parseInt(locationIndex)];
            let html = '<option value="">Select a drink or enter custom below...</option>';
            for (let i = 0; i < drinks.length; i++) {
                html += '<option value="' + drinks[i] + '">' + drinks[i] + '</option>';
            }
            drinkSelect.innerHTML = html;
        }

        function clearPhoto() {
            currentPhotoData = null;
            document.getElementById('photo').value = '';
            document.getElementById('photoPreview').style.display = 'none';
        }

        async function deleteDrink(id) {
            if (confirm('Delete this drink?')) {
                try {
                    await deleteDrinkFromDB(id);
                    drinks = drinks.filter(d => d.id !== id);
                    updateDisplay();
                } catch (error) {
                    console.error('Error deleting drink:', error);
                    alert('Error deleting drink. Please try again.');
                }
            }
        }

        function openPhotoModal(drinkId) {
            const drink = drinks.find(d => d.id === drinkId);
            if (drink && drink.photo) {
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;';
                modal.onclick = function() { document.body.removeChild(modal); };
                
                const img = document.createElement('img');
                img.src = drink.photo;
                img.style.cssText = 'max-width: 100%; max-height: 100%; border-radius: 8px;';
                
                modal.appendChild(img);
                document.body.appendChild(modal);
            }
        }

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Location change
            document.getElementById('location').addEventListener('change', updateDrinkOptions);
            
            // Photo input
            document.getElementById('photo').addEventListener('change', function(e) {
                console.log('Photo input changed');
                const file = e.target.files[0];
                if (file) {
                    console.log('File selected:', file.name, file.size);
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        currentPhotoData = event.target.result;
                        document.getElementById('previewImg').src = currentPhotoData;
                        document.getElementById('photoPreview').style.display = 'block';
                        console.log('Photo loaded');
                    };
                    reader.readAsDataURL(file);
                } else {
                    console.log('No file selected');
                }
            });

            // Remove photo button
            document.getElementById('removePhotoBtn').addEventListener('click', clearPhoto);

            // Form submission
            document.getElementById('drinkForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                console.log('Form submitted');
                
                const locationValue = document.getElementById('location').value;
                let drinkNameValue = document.getElementById('drinkName').value;
                const drinkSelectValue = document.getElementById('drinkSelect').value;
                const ratingValue = document.getElementById('rating').value;
                const notesValue = document.getElementById('notes').value;
                
                console.log('Form values:', { locationValue, drinkNameValue, drinkSelectValue, ratingValue });
                
                if (!locationValue || !ratingValue) {
                    alert('Please fill in all required fields!');
                    return;
                }
                
                if (!drinkNameValue && drinkSelectValue) {
                    drinkNameValue = drinkSelectValue;
                }
                
                if (!drinkNameValue) {
                    alert('Please select a drink or enter a custom drink name!');
                    return;
                }
                
                const drink = {
                    id: Date.now(),
                    locationIndex: parseInt(locationValue),
                    drinkName: drinkNameValue,
                    rating: parseInt(ratingValue),
                    notes: notesValue,
                    photo: currentPhotoData
                };
                
                console.log('Attempting to save drink:', drink);
                
                try {
                    await saveDrink(drink);
                    drinks.push(drink);
                    
                    document.getElementById('drinkForm').reset();
                    clearPhoto();
                    updateDisplay();
                    alert('Drink added successfully!');
                } catch (error) {
                    console.error('Error saving drink:', error);
                    alert('Error saving drink: ' + error.message);
                }
            });
            
            console.log('Event listeners attached!');
        }

        // Initialize app
        async function init() {
            try {
                console.log('Initializing app...');
                await initDB();
                console.log('Database initialized');
                await loadData();
                console.log('Data loaded:', drinks.length, 'drinks');
                updateDisplay();
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                console.log('App ready!');
                
                // Attach event listeners AFTER content is displayed
                setupEventListeners();
            } catch (error) {
                console.error('Error initializing app:', error);
                document.getElementById('loadingMessage').innerHTML = '<p style="color: #dc3545;">Error loading app: ' + error.message + '</p>';
            }
        }

        init();
    </script>
</body>
</html>